# Ansible Playbook Quick Reference

## ðŸš€ Quick Start Commands

```bash
# Test connectivity
ansible all -i inventory.ini -m ping

# Run full playbook
ansible-playbook -i inventory.ini setup-playbook.yml

# Run with verbose output
ansible-playbook -i inventory.ini setup-playbook.yml -v
```

## ðŸ“‹ File Overview

| File | Purpose |
|------|---------|
| `setup-playbook.yml` | Basic playbook - all components |
| `setup-playbook-tagged.yml` | Enhanced with tags and handlers |
| `inventory.ini` | Host configuration |
| `ansible.cfg` | Ansible settings (optional) |
| `vagrant-ssh-config` | SSH config for Vagrant (auto-generated) |

## ðŸ·ï¸ Using Tags (Enhanced Playbook)

```bash
# Install only Tailscale
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags tailscale

# Install Docker and K3s
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags docker,k3s

# Skip uv-python
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --skip-tags uv

# Only verify installations
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags verify

# Install everything except K3s
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --skip-tags k3s
```

## âš™ï¸ Common Options

```bash
# Dry run (check mode)
ansible-playbook -i inventory.ini setup-playbook.yml --check

# Step through tasks
ansible-playbook -i inventory.ini setup-playbook.yml --step

# Start at specific task
ansible-playbook -i inventory.ini setup-playbook.yml --start-at-task="DOCKER | Install Docker packages"

# Limit to specific host
ansible-playbook -i inventory.ini setup-playbook.yml --limit vagrant_host1

# Extra variables
ansible-playbook -i inventory.ini setup-playbook.yml -e "k3s_token=my-secure-token"

# Ask for sudo password
ansible-playbook -i inventory.ini setup-playbook.yml --ask-become-pass
```

## ðŸ” Verification Commands

```bash
# Verify Tailscale
ansible all -i inventory.ini -a "tailscale status"
ansible all -i inventory.ini -a "tailscale ip -4"

# Verify Docker
ansible all -i inventory.ini -a "docker --version"
ansible all -i inventory.ini -a "docker ps"

# Verify K3s
ansible all -i inventory.ini -a "k3s kubectl get nodes"
ansible all -i inventory.ini -a "k3s kubectl get pods -A"

# Verify uv
ansible all -i inventory.ini -a "~/.cargo/bin/uv --version"
```

## ðŸ“Š Inventory Examples

### Local Machine
```ini
[all]
localhost ansible_connection=local
```

### Vagrant VM
```ini
[all]
default

[all:vars]
ansible_connection=ssh
```
*Note: Requires `vagrant-ssh-config` and `ansible.cfg`*

### Remote Server
```ini
[all]
myserver ansible_host=192.168.1.100 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa
```

### Multiple Servers
```ini
[k3s_cluster]
master ansible_host=192.168.1.100 ansible_user=ubuntu
worker1 ansible_host=192.168.1.101 ansible_user=ubuntu
worker2 ansible_host=192.168.1.102 ansible_user=ubuntu
```

## ðŸ› ï¸ Setup for Different Scenarios

### Vagrant Setup
```bash
# 1. Start VM
vagrant up

# 2. Generate SSH config
vagrant ssh-config > vagrant-ssh-config

# 3. Create ansible.cfg
cat > ansible.cfg << 'EOF'
[defaults]
inventory = inventory.ini
host_key_checking = False

[ssh_connection]
ssh_args = -F vagrant-ssh-config
EOF

# 4. Update inventory.ini
cat > inventory.ini << 'EOF'
[all]
default
EOF

# 5. Run playbook
ansible-playbook setup-playbook.yml
```

### Remote Server Setup
```bash
# 1. Update inventory.ini
cat > inventory.ini << 'EOF'
[all]
server ansible_host=YOUR_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/your_key.pem
EOF

# 2. Test connection
ansible all -i inventory.ini -m ping

# 3. Run playbook
ansible-playbook -i inventory.ini setup-playbook.yml
```

## ðŸ› Troubleshooting Commands

```bash
# Test SSH connection
ansible all -i inventory.ini -m ping -vvv

# Check inventory
ansible-inventory -i inventory.ini --list
ansible-inventory -i inventory.ini --graph

# View host variables
ansible-inventory -i inventory.ini --host hostname

# Gather facts
ansible all -i inventory.ini -m setup

# Check specific fact
ansible all -i inventory.ini -m setup -a "filter=ansible_distribution"
```

## ðŸ”„ Re-running & Updates

```bash
# Re-run entire playbook (idempotent)
ansible-playbook -i inventory.ini setup-playbook.yml

# Force reinstall Docker
ansible all -i inventory.ini -b -a "apt remove -y docker-ce"
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags docker

# Update only one component
ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags tailscale
```

## ðŸ“ Variable Overrides

```bash
# Change K3s token
ansible-playbook -i inventory.ini setup-playbook.yml \
  -e "k3s_token=$(openssl rand -hex 32)"

# Disable specific component
ansible-playbook -i inventory.ini setup-playbook-tagged.yml \
  -e "install_k3s=false"

# Multiple variables
ansible-playbook -i inventory.ini setup-playbook.yml \
  -e "k3s_token=abc123" \
  -e "tailscale_interface=tailscale0"

# From file
ansible-playbook -i inventory.ini setup-playbook.yml \
  -e "@extra_vars.yml"
```

## ðŸŽ¯ Common Tasks

### Check Installation Status
```bash
ansible all -i inventory.ini -m command -a "which tailscale"
ansible all -i inventory.ini -m command -a "which docker"
ansible all -i inventory.ini -m command -a "which k3s"
ansible all -i inventory.ini -m shell -a "su - $USER -c 'command -v uv'"
```

### Get System Info
```bash
ansible all -i inventory.ini -a "hostname"
ansible all -i inventory.ini -a "uname -a"
ansible all -i inventory.ini -a "cat /etc/os-release"
ansible all -i inventory.ini -a "df -h"
ansible all -i inventory.ini -a "free -m"
```

### Service Management
```bash
# Check Docker service
ansible all -i inventory.ini -b -m service -a "name=docker state=started"

# Restart K3s
ansible all -i inventory.ini -b -m service -a "name=k3s state=restarted"

# Check all services
ansible all -i inventory.ini -a "systemctl status docker k3s"
```

## ðŸ” Security Best Practices

### Use Ansible Vault
```bash
# Encrypt variable
ansible-vault encrypt_string 'my-secret-token' --name 'k3s_token'

# Create encrypted file
ansible-vault create secrets.yml

# Run playbook with vault
ansible-playbook -i inventory.ini setup-playbook.yml --ask-vault-pass

# Use vault password file
ansible-playbook -i inventory.ini setup-playbook.yml --vault-password-file ~/.vault_pass
```

### SSH Key Setup
```bash
# Generate SSH key
ssh-keygen -t ed25519 -C "ansible" -f ~/.ssh/ansible_key

# Copy to server
ssh-copy-id -i ~/.ssh/ansible_key.pub user@server

# Use in inventory
[all]
server ansible_ssh_private_key_file=~/.ssh/ansible_key
```

## ðŸ“Š Parallel Execution

```bash
# Run on 5 hosts at once (default is 5)
ansible-playbook -i inventory.ini setup-playbook.yml -f 5

# Run on 10 hosts at once
ansible-playbook -i inventory.ini setup-playbook.yml -f 10

# Serial execution (one at a time)
ansible-playbook -i inventory.ini setup-playbook.yml -f 1
```

## ðŸ’¾ Saving Output

```bash
# Save to file
ansible-playbook -i inventory.ini setup-playbook.yml | tee output.log

# Save with timestamp
ansible-playbook -i inventory.ini setup-playbook.yml | tee "output-$(date +%Y%m%d-%H%M%S).log"

# JSON output
ansible-playbook -i inventory.ini setup-playbook.yml -vvv 2>&1 | tee debug.json
```

## ðŸŽ“ Ansible Ad-Hoc Command Examples

```bash
# Ping all hosts
ansible all -i inventory.ini -m ping

# Run shell command
ansible all -i inventory.ini -a "uptime"

# Install package
ansible all -i inventory.ini -b -m apt -a "name=htop state=present"

# Copy file
ansible all -i inventory.ini -m copy -a "src=file.txt dest=/tmp/file.txt"

# Create directory
ansible all -i inventory.ini -b -m file -a "path=/opt/myapp state=directory mode=0755"

# Restart service
ansible all -i inventory.ini -b -m service -a "name=docker state=restarted"

# Get file content
ansible all -i inventory.ini -m shell -a "cat /etc/hostname"
```

## ðŸƒ Performance Tips

```bash
# Enable pipelining (in ansible.cfg)
[ssh_connection]
pipelining = True

# Increase SSH connections
[defaults]
forks = 10

# Use mitogen for speed
pip install mitogen
# Add to ansible.cfg:
[defaults]
strategy_plugins = /path/to/mitogen/ansible_mitogen/plugins/strategy
strategy = mitogen_linear
```

## ðŸ“š Useful Aliases

Add to `~/.bashrc` or `~/.zshrc`:

```bash
# Ansible shortcuts
alias ap='ansible-playbook'
alias api='ansible-playbook -i inventory.ini'
alias apc='ansible-playbook -i inventory.ini --check'
alias apv='ansible-playbook -i inventory.ini -v'
alias aping='ansible all -i inventory.ini -m ping'

# Vagrant + Ansible
alias vconf='vagrant ssh-config > vagrant-ssh-config'
alias vap='vagrant up && ansible-playbook -i inventory.ini'
```

## ðŸŽ¯ Decision Matrix

| Scenario | Command |
|----------|---------|
| First time setup | `ansible-playbook -i inventory.ini setup-playbook.yml` |
| Only install Docker | `ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags docker` |
| Skip K3s | `ansible-playbook -i inventory.ini setup-playbook-tagged.yml --skip-tags k3s` |
| Verify all | `ansible-playbook -i inventory.ini setup-playbook-tagged.yml --tags verify` |
| Dry run | `ansible-playbook -i inventory.ini setup-playbook.yml --check` |
| Debug mode | `ansible-playbook -i inventory.ini setup-playbook.yml -vvv` |
| Specific host | `ansible-playbook -i inventory.ini setup-playbook.yml --limit host1` |

## âœ… Pre-flight Checklist

Before running the playbook:

- [ ] Target system is Debian/Ubuntu
- [ ] You have sudo privileges
- [ ] SSH access is configured
- [ ] Inventory file is updated
- [ ] Test with: `ansible all -i inventory.ini -m ping`
- [ ] Vagrant SSH config generated (if using Vagrant)
- [ ] ansible.cfg created (if needed)

## ðŸ†˜ Common Errors

### "Failed to connect"
```bash
# Solution: Check SSH access
ssh -F vagrant-ssh-config hostname
ansible all -i inventory.ini -m ping -vvv
```

### "Permission denied"
```bash
# Solution: Check sudo privileges
ansible all -i inventory.ini -b -a "whoami"
```

### "Package not found"
```bash
# Solution: Update apt cache
ansible all -i inventory.ini -b -m apt -a "update_cache=yes"
```

## ðŸ“– Quick Reference Links

- [Ansible Documentation](https://docs.ansible.com/)
- [Ansible Modules Index](https://docs.ansible.com/ansible/latest/modules/modules_by_category.html)
- [Best Practices](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)

---

**Remember:** Most commands support `-h` for help:
```bash
ansible --help
ansible-playbook --help
ansible-vault --help
```
