# Machine Setup Ansible Playbook

Complete automated setup for a development/production machine with Tailscale, Docker, K3s, and uv-python.

## ğŸ“¦ What Gets Installed

1. **Tailscale** - VPN mesh network for secure connectivity
2. **Docker** - Container runtime with Docker Compose
3. **K3s** - Lightweight Kubernetes cluster
4. **uv-python** - Fast Python package installer

## ğŸš€ Quick Start

### Prerequisites

- Debian-based system (Debian 11+, Ubuntu 20.04+)
- Ansible installed on control machine
- sudo privileges on target machine
- Internet connection

### Basic Usage

```bash
# 1. Test connectivity
ansible all -i inventory.ini -m ping

# 2. Run the playbook
ansible-playbook -i inventory.ini setup-playbook.yml

# 3. Run with verbose output
ansible-playbook -i inventory.ini setup-playbook.yml -v
```

## ğŸ“‹ Installation Steps

### Step 1: Install Ansible (on your control machine)

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y ansible

# macOS
brew install ansible

# Verify installation
ansible --version
```

### Step 2: Prepare Inventory File

Edit `inventory.ini` to match your setup:

**For Local Machine:**
```ini
[all]
localhost ansible_connection=local
```

**For Vagrant VM:**
```ini
[all]
vagrant_host1

[all:vars]
ansible_connection=ssh
```

**For Remote Server:**
```ini
[all]
myserver ansible_host=192.168.1.100 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa
```

### Step 3: Generate SSH Config (if using Vagrant)

```bash
vagrant ssh-config > vagrant-ssh-config

# Create ansible.cfg
cat > ansible.cfg << 'EOF'
[defaults]
inventory = inventory.ini
host_key_checking = False

[ssh_connection]
ssh_args = -F vagrant-ssh-config
EOF
```

### Step 4: Test Connectivity

```bash
ansible all -i inventory.ini -m ping
```

Expected output:
```
localhost | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
```

### Step 5: Run the Playbook

```bash
ansible-playbook -i inventory.ini setup-playbook.yml
```

## âš™ï¸ Configuration Options

### Customize K3s Token

Edit the playbook variables:

```yaml
vars:
  k3s_token: "your-secure-token-here"  # Change this!
```

Or pass at runtime:

```bash
ansible-playbook -i inventory.ini setup-playbook.yml \
  -e "k3s_token=my-secure-token"
```

### Skip Specific Components

Use tags to run only specific parts:

```bash
# Only install Docker
ansible-playbook -i inventory.ini setup-playbook.yml --tags docker

# Skip K3s installation
ansible-playbook -i inventory.ini setup-playbook.yml --skip-tags k3s
```

**Note:** The current playbook doesn't have tags. To add tags, modify the playbook:

```yaml
- name: "DOCKER | Install Docker packages"
  tags: docker
  apt:
    name:
      - docker-ce
    state: present
```

## ğŸ”§ Common Scenarios

### Scenario 1: Fresh Vagrant VM

```bash
# 1. Start VM
vagrant up

# 2. Generate SSH config
vagrant ssh-config > vagrant-ssh-config

# 3. Update inventory.ini
cat > inventory.ini << 'EOF'
[all]
default

[all:vars]
ansible_connection=ssh
EOF

# 4. Create ansible.cfg
cat > ansible.cfg << 'EOF'
[defaults]
inventory = inventory.ini
host_key_checking = False

[ssh_connection]
ssh_args = -F vagrant-ssh-config
EOF

# 5. Run playbook
ansible-playbook setup-playbook.yml
```

### Scenario 2: Remote Ubuntu Server

```bash
# 1. Update inventory.ini
cat > inventory.ini << 'EOF'
[all]
production ansible_host=YOUR_SERVER_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/your_key.pem
EOF

# 2. Test connection
ansible all -m ping

# 3. Run playbook
ansible-playbook -i inventory.ini setup-playbook.yml
```

### Scenario 3: Multiple Servers

```bash
# 1. Update inventory.ini
cat > inventory.ini << 'EOF'
[k3s_cluster]
master ansible_host=192.168.1.100 ansible_user=ubuntu
worker1 ansible_host=192.168.1.101 ansible_user=ubuntu
worker2 ansible_host=192.168.1.102 ansible_user=ubuntu
EOF

# 2. Run on all servers
ansible-playbook -i inventory.ini setup-playbook.yml

# 3. Run on specific server
ansible-playbook -i inventory.ini setup-playbook.yml --limit master
```

## ğŸ” Verification

After installation, verify each component:

### Tailscale
```bash
# Check status
ansible all -a "tailscale status"

# Get IP
ansible all -a "tailscale ip -4"
```

### Docker
```bash
# Check version
ansible all -a "docker --version"

# Test Docker
ansible all -a "docker run hello-world"
```

### K3s
```bash
# Check nodes
ansible all -a "k3s kubectl get nodes"

# Check pods
ansible all -a "k3s kubectl get pods -A"
```

### uv-python
```bash
# Check version
ansible all -a "~/.cargo/bin/uv --version"
```

## ğŸ› Troubleshooting

### Issue 1: Ansible Cannot Connect

**Problem:**
```
fatal: [host]: UNREACHABLE! => {"msg": "Failed to connect to the host via ssh"}
```

**Solution:**
```bash
# Test SSH manually
ssh -F vagrant-ssh-config hostname

# Check inventory
ansible-inventory -i inventory.ini --list

# Use verbose mode
ansible all -m ping -vvv
```

### Issue 2: Tailscale Requires Authentication

**Problem:**
Tailscale installed but not authenticated.

**Solution:**
```bash
# SSH into the machine
vagrant ssh  # or ssh to your server

# Authenticate Tailscale
sudo tailscale up

# Follow the URL to authenticate
```

### Issue 3: Permission Denied for Docker

**Problem:**
```
Got permission denied while trying to connect to the Docker daemon socket
```

**Solution:**
```bash
# User needs to log out and back in for group membership
# Or run:
ansible all -a "newgrp docker"

# Or manually on the machine:
vagrant ssh
newgrp docker
```

### Issue 4: K3s Installation Fails

**Problem:**
K3s fails because Tailscale IP not available.

**Solution:**
1. Ensure Tailscale is authenticated first
2. Run playbook again after authentication
3. Or manually set the IP:

```bash
ansible-playbook -i inventory.ini setup-playbook.yml \
  -e "tailscale_ip=100.64.1.2"
```

### Issue 5: uv-python Not in PATH

**Problem:**
`uv: command not found`

**Solution:**
```bash
# Reload shell
source ~/.bashrc

# Or add to current session
export PATH="$HOME/.cargo/bin:$PATH"

# Verify
uv --version
```

## ğŸ“ Post-Installation Steps

### 1. Docker Setup

```bash
# SSH into machine
vagrant ssh

# Verify Docker works without sudo
docker run hello-world

# If permission denied, log out and back in
exit
vagrant ssh
```

### 2. K3s Setup

```bash
# Set KUBECONFIG
export KUBECONFIG=$HOME/.kube/config

# Test kubectl
kubectl get nodes
kubectl get pods -A

# Add to .bashrc for persistence
echo 'export KUBECONFIG=$HOME/.kube/config' >> ~/.bashrc
```

### 3. Tailscale Authentication

```bash
# If not done during playbook run
sudo tailscale up

# Visit the provided URL to authenticate

# Verify connection
tailscale status
tailscale ip -4
```

### 4. uv-python Setup

```bash
# Reload shell
source ~/.bashrc

# Test uv
uv --version

# Create a Python environment
uv venv myproject
source myproject/bin/activate

# Install packages
uv pip install requests
```

## ğŸ”„ Updating Components

To update or reinstall:

```bash
# Re-run entire playbook (idempotent)
ansible-playbook -i inventory.ini setup-playbook.yml

# Force reinstallation by first removing
ansible all -b -a "apt remove -y docker-ce docker-ce-cli"
ansible-playbook -i inventory.ini setup-playbook.yml
```

## ğŸ§¹ Cleanup

To remove installed components:

```bash
# Remove Docker
ansible all -b -a "apt remove -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin"

# Remove K3s
ansible all -b -a "/usr/local/bin/k3s-uninstall.sh"

# Remove Tailscale
ansible all -b -a "apt remove -y tailscale"

# Remove uv
ansible all -a "rm -rf ~/.cargo"
```

## ğŸ“š Additional Resources

- [Ansible Documentation](https://docs.ansible.com/)
- [Tailscale Setup Guide](https://tailscale.com/kb/start/)
- [Docker Documentation](https://docs.docker.com/)
- [K3s Documentation](https://docs.k3s.io/)
- [uv Documentation](https://github.com/astral-sh/uv)

## ğŸ¤ Tips & Best Practices

### Security

1. **Change K3s Token:** Don't use the default token in production
   ```yaml
   k3s_token: "$(openssl rand -hex 32)"
   ```

2. **Use Ansible Vault:** Encrypt sensitive data
   ```bash
   ansible-vault encrypt_string 'my-secret-token' --name 'k3s_token'
   ```

3. **SSH Keys:** Always use SSH keys, never passwords
   ```bash
   ssh-keygen -t ed25519 -C "ansible"
   ssh-copy-id -i ~/.ssh/id_ed25519.pub user@host
   ```

### Performance

1. **Enable SSH Pipelining:** In `ansible.cfg`
   ```ini
   [ssh_connection]
   pipelining = True
   ```

2. **Increase Parallelism:**
   ```bash
   ansible-playbook -i inventory.ini setup-playbook.yml -f 10
   ```

### Debugging

1. **Dry Run:** Check what would change
   ```bash
   ansible-playbook -i inventory.ini setup-playbook.yml --check
   ```

2. **Step Through:** Run one task at a time
   ```bash
   ansible-playbook -i inventory.ini setup-playbook.yml --step
   ```

3. **Verbose Output:** See detailed execution
   ```bash
   ansible-playbook -i inventory.ini setup-playbook.yml -vvv
   ```

## ğŸ“Š Playbook Structure

```
.
â”œâ”€â”€ setup-playbook.yml    # Main playbook
â”œâ”€â”€ inventory.ini         # Host inventory
â”œâ”€â”€ ansible.cfg          # Ansible configuration (optional)
â””â”€â”€ vagrant-ssh-config   # SSH config (for Vagrant)
```

## ğŸ“ Learning More

### Run Individual Tasks

```bash
# Test Tailscale installation
ansible all -i inventory.ini -m shell -a "curl -fsSL https://tailscale.com/install.sh | sh" -b

# Check Docker status
ansible all -i inventory.ini -m service -a "name=docker state=started" -b

# Get K3s nodes
ansible all -i inventory.ini -a "k3s kubectl get nodes"
```

### Create Custom Playbooks

Based on this playbook, you can create variations:

```yaml
# minimal-playbook.yml - Only Docker and uv
---
- name: Minimal Setup
  hosts: all
  become: yes
  tasks:
    # Include only Docker and uv tasks
```

## âœ… Success Criteria

After running the playbook successfully:

- [ ] Tailscale is installed and authenticated
- [ ] Tailscale IP is obtained (e.g., 100.x.x.x)
- [ ] Docker is running and user can run `docker ps`
- [ ] K3s cluster is running and accessible
- [ ] kubectl can connect to the cluster
- [ ] uv-python is installed and in PATH
- [ ] No errors in the playbook output

## ğŸ†˜ Getting Help

If you encounter issues:

1. **Check Ansible Logs:** Run with `-vvv` for detailed output
2. **Verify Prerequisites:** Ensure target system meets requirements
3. **Test Manually:** Try running the commands manually on the target system
4. **Check System Logs:** `journalctl -u docker`, `journalctl -u k3s`

## ğŸ“„ License

This playbook is provided as-is for educational and production use.

---

**Happy Automating! ğŸš€**
